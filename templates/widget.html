<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Betty – Chatbot Danse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#fdf7f9; --bubble-user:#e8f6fb; --bubble-bot:#f1dff1;
      --ink:#2b2240; --btn:#ff6fae; --btn-ink:#fff;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); font-family: system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
      margin:0; padding:24px; color:var(--ink); display:flex; flex-direction:column; align-items:center;
    }
    .chatbox{
      width:100%; max-width:720px; background:#fff; border-radius:24px;
      box-shadow:0 8px 28px rgba(0,0,0,.08); padding:24px; min-height:340px;
    }
    .head{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .head img{ width:70px; height:auto }
    .msg{ margin:14px 0 }
    .bubble{
      display:inline-block; padding:16px 18px; border-radius:18px; line-height:1.5; font-size:18px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .user{ background:var(--bubble-user); float:right; clear:both }
    .bot{ background:var(--bubble-bot); float:left; clear:both }
    .field{ display:flex; gap:12px; margin-top:14px; align-items:center; clear:both }
    input[type=text]{
      flex:1; font-size:18px; padding:14px 16px; border-radius:14px; border:1px solid #d9d9e3; outline:none;
    }
    button{
      background:var(--btn); color:var(--btn-ink); border:none; border-radius:14px; padding:12px 18px; font-size:16px;
      cursor:pointer;
    }
    .thinking{ color:#7a708c; font-style:italic; margin-top:6px; display:none }
    .thinking .dots::after{ content:"…"; animation:dots 1.2s steps(3,end) infinite }
    @keyframes dots{0%{content:""}33%{content:"."}66%{content:".."}100%{content:"..."}}
    a{ color:#4a2bb8; text-decoration:underline }
  </style>
</head>
<body>

  <div class="chatbox" id="chat">
    <div class="head">
      <img src="/static/images/betty_pirouette.gif" alt="Betty fait une pirouette !" />
      <div>
        <div class="bubble bot">
          Bonjour ! Je suis <strong>Betty</strong>, l’assistante du Centre de Danse Delphine Letort 💃<br />
          Que puis-je faire pour vous ?
        </div>
      </div>
    </div>

    <div id="messages"></div>

    <div class="field">
      <input id="user-input" type="text" placeholder="Écrivez votre message ici…" autocomplete="off" />
      <button id="send-btn">Envoyer</button>
    </div>

    <div class="thinking" id="thinking">Betty réfléchit <span class="dots"></span></div>
  </div>

  <script>
    const $msgs = document.getElementById('messages');
    const $input = document.getElementById('user-input');
    const $send = document.getElementById('send-btn');
    const $thinking = document.getElementById('thinking');

    function esc(t){ return t.replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

    // Convertit [texte](https://url) en lien <a target="_blank">
    function linkify(md){
      return md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m,txt,href)=>{
        try{
          const u = new URL(href);
          if(!/^https?:$/.test(u.protocol)) return esc(txt); // refuse tout sauf http(s)
          return `<a href="${u.href}" target="_blank" rel="noopener">${esc(txt)}</a>`;
        }catch{ return esc(txt); }
      });
    }

    function append(type, text){
      const d = document.createElement('div');
      d.className = 'msg';
      const b = document.createElement('div');
      b.className = `bubble ${type}`;
      // On échappe tout puis on remet uniquement des liens MD → HTML sûrs
      b.innerHTML = linkify(esc(text));
      d.appendChild(b);
      $msgs.appendChild(d);
      b.scrollIntoView({behavior:'smooth', block:'end'});
    }

    async function sendMessage(){
      const t = $input.value.trim();
      if(!t) return;
      append('user', t);
      $input.value = '';
      $thinking.style.display = 'block';
      try{
        const res = await fetch('/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ question: t })
        });
        const data = await res.json();
        $thinking.style.display = 'none';
        if(data.reply){
          append('bot', data.reply);
        }else{
          append('bot', "Désolée, je ne peux pas répondre pour le moment 😔");
        }
      }catch(e){
        $thinking.style.display = 'none';
        append('bot', "Oups, petite panne réseau. Réessayez dans un instant 🙏");
      }
    }

    $send.addEventListener('click', sendMessage);
    $input.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });
  </script>
</body>
</html>
