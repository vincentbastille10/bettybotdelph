<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Betty â€“ Chatbot Danse</title>
  <style>
    :root{
      --bg:#fdf7f9;
      --bot:#f3e5f5;
      --user:#e0f7fa;
      --card:#ffffff;
      --text:#1b1b1b;
      --pink:#ff69b4;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:flex; flex-direction:column; align-items:center;
      padding:28px 16px 28px;
    }
    .wrap{ width:100%; max-width:900px; display:flex; justify-content:center; }
    .card{
      width:100%; max-width:680px; background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:22px;
    }
    .hero{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .hero img{ width:80px; height:auto }
    .title{
      background:var(--bot); border-radius:16px; padding:16px; font-size:18px; font-weight:600;
    }
    .chat{ display:flex; flex-direction:column; gap:12px; margin:14px 0 16px; max-height:60vh; overflow:auto; padding-right:4px }
    .msg{ padding:12px 14px; border-radius:14px; max-width:85%; white-space:pre-wrap; word-wrap:break-word }
    .msg a{ color:#0a58ca; text-decoration:underline; }
    .bot{ background:var(--bot); align-self:flex-start }
    .user{ background:var(--user); align-self:flex-end; text-align:right }
    .typing{ opacity:.7; font-style:italic }
    .row{ display:flex; gap:10px }
    .row input{
      flex:1; background:#fff; border:1px solid #e4e4e7; border-radius:12px; padding:14px 12px; font-size:16px;
      outline:none; box-shadow:0 1px 0 rgba(0,0,0,.03) inset;
    }
    .row button{
      background:var(--pink); color:#fff; border:0; border-radius:12px; padding:0 18px; min-width:110px;
      font-weight:600; cursor:pointer; transition:transform .05s ease;
    }
    .row button:active{ transform:translateY(1px) }
    @media (max-width:520px){
      .card{ padding:16px }
      .title{ font-size:16px }
      .row input{ padding:12px }
      .row button{ min-width:92px }
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <div class="hero">
        <img src="/static/images/betty_pirouette.gif" alt="Betty fait une pirouette !">
      </div>

      <div class="title">
        Bonjour ! Je suis <b>Betty</b>, lâ€™assistante du Centre de Danse Delphine Letort ðŸ’ƒ Que puis-je faire pour vous ?
      </div>

      <div id="chat" class="chat"></div>

      <div class="row">
        <input id="msg" type="text" placeholder="Ã‰crivez votre message iciâ€¦" autocomplete="off" />
        <button id="send">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    const chat  = document.getElementById('chat');
    const input = document.getElementById('msg');
    const send  = document.getElementById('send');

    // message dâ€™accueil dans le flux
    addMsg("Que puis-je faire pour vous ?", "bot");

    function addMsg(text, who){
      const div = document.createElement('div');
      div.className = `msg ${who}`;

      if (who === 'bot') {
        // transforme [texte](url) -> <a href="url">texte</a> pour des liens cliquables
        const html = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
          '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        div.innerHTML = html;
      } else {
        div.textContent = text;
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function setTyping(on){
      if (on){
        window._typing = addMsg("Betty rÃ©flÃ©chitâ€¦", "bot typing");
      } else if (window._typing){
        window._typing.remove();
        window._typing = null;
      }
    }

    async function ask(){
      const text = (input.value || "").trim();
      if (!text) return;
      addMsg(text, "user");
      input.value = "";
      setTyping(true);

      try{
        const r = await fetch("/chat", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ message: text })
        });
        const j = await r.json();
        setTyping(false);

        if (j.reply){
          addMsg(j.reply, "bot");
        } else {
          addMsg("Oups : " + (j.error || "erreur inconnue"), "bot");
        }
      }catch(e){
        setTyping(false);
        addMsg("DÃ©solÃ©e, je ne peux pas rÃ©pondre pour le moment ðŸ˜”", "bot");
      }
    }

    send.addEventListener('click', ask);
    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') ask(); });
    window.addEventListener('load', ()=> input.focus());
  </script>
</body>
</html>
